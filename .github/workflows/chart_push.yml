name: Publish chart to registry
on: 
  push:
    branches:
      - 'main'
    paths:
      - 'basic-web-service/Chart.yaml'
  workflow_dispatch: {}
jobs:
  publish_chart:
    runs-on: ubuntu-latest
    env:
      REGISTRY_HOSTNAME: "us-central1-docker.pkg.dev"
    steps:
    - uses: 'actions/checkout@v3'
    - name: Get latest chart version number
      run: echo "CHART_VERSION=$(cat basic-web-service/Chart.yaml | grep 'version:' | cut -d' ' -f2)" >> $GITHUB_ENV
    - name: Check for matching archive
      run: |
        echo "If this step fails, we couldn't find the file 'charts/basic-web-service-${CHART_VERSION}.tgz'" && [[ -e  "charts/basic-web-service-${CHART_VERSION}.tgz" ]]
    - uses: azure/setup-helm@v3
      with:
        version: 'latest'
        token: ${{ secrets.GITHUB_TOKEN }} # only needed if version is 'latest'
    - name: 'Authenticate to Google Artifact Registry'
      env:
        GAR_KEY_BASE64: ${{ secrets.GAR_KEY_BASE64 }}
        REGISTRY_URL_HTTP: "https://${{ env.REGISTRY_HOSTNAME }}"
      run: |
        echo $GAR_KEY_BASE64 | helm registry login -u _json_key_base64 --password-stdin \
        $REGISTRY_URL_HTTP
    - name: 'Upload chart'
      env:
        REGISTRY_URL_OCI: "oci://${{env.REGISTRY_HOSTNAME}}/uwit-mci-iam/helm-charts-test"
      run: |
        helm push charts/basic-web-service-${CHART_VERSION}.tgz $REGISTRY_URL_OCI

